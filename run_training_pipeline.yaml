# This file's only job is to compile and start a Vertex AI pipeline run.
# It's meant to be triggered by changes to the 'dataset' branch.
steps:
  # Step 1: Use a python container for all python-related tasks.
  - name: "python:3.9-slim"
    id: "CompilePipeline"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        pip install google-cloud-aiplatform kfp
        python3 pipeline.py
  # Step 2: Use the Google Cloud SDK container to submit the pipeline.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "RunTrainingPipeline"
    entrypoint: "gcloud"
    args:
      - "ai"
      - "pipelines"
      - "run"
      - "--project=${PROJECT_ID}"
      - "--region=europe-west4"
      - "--template-path=wine_quality_pipeline_git_triggered.yaml"
      - "--display-name=data-triggered-run-${SHORT_SHA}"
      - "--pipeline-root=gs://yannick-pipeline-root"
      - "--service-account=793868790421-compute@developer.gserviceaccount.com"
      - "--enable-caching=false"
    waitFor: ["CompilePipeline"]