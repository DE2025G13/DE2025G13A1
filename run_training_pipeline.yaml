# This file's only job is to compile and start a Vertex AI pipeline run.
# It's meant to be triggered by changes to the 'dataset' branch.
options:
  logging: CLOUD_LOGGING_ONLY
steps:
  # First, install the Python libraries needed to compile and run the pipeline.
  - name: "python:3.9-slim"
    id: "InstallPipelineSDKs"
    entrypoint: "pip"
    args: ["install", "google-cloud-aiplatform", "kfp"]
  # Next, compile our pipeline.py into a YAML file that Vertex AI can read.
  - name: "python:3.9-slim"
    id: "CompilePipeline"
    entrypoint: "python3"
    args: ["pipeline.py"]
    waitFor: ["InstallPipelineSDKs"]
  # Finally, submit the compiled YAML to Vertex AI to start the training run.
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "RunTrainingPipeline"
    entrypoint: "gcloud"
    args:
      - "ai"
      - "pipelines"
      - "run"
      - "--project=${PROJECT_ID}"
      - "--region=europe-west4"
      - "--template-path=wine_quality_pipeline_git_triggered.yaml"
      - "--display-name=data-triggered-run-${SHORT_SHA}"
      - "--pipeline-root=gs://yannick-pipeline-root"
      - "--service-account=793868790421-compute@developer.gserviceaccount.com"
      - "--enable-caching=false"
    waitFor: ["CompilePipeline"]