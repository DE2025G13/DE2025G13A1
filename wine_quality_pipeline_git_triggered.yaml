# PIPELINE DEFINITION
# Name: wine-quality-git-triggered-pipeline
# Inputs:
#    cd_trigger_id: str [Default: 'deploy-wine-app-trigger']
#    input_data_gcs_path: str [Default: 'gs://yannick-pipeline-root/datasets/wine-latest.csv']
#    model_bucket: str [Default: 'yannick-wine-models']
#    project_id: str [Default: 'data-engineering-vm']
components:
  comp-condition-1:
    dag:
      tasks:
        trigger-cd-pipeline-op:
          cachingOptions:
            enableCache: true
          componentRef:
            name: comp-trigger-cd-pipeline-op
          inputs:
            parameters:
              new_model_uri:
                componentInputParameter: pipelinechannel--model-evaluator-op-best_model_uri
              project_id:
                componentInputParameter: pipelinechannel--project_id
              trigger_id:
                componentInputParameter: pipelinechannel--cd_trigger_id
          taskInfo:
            name: trigger-cd-pipeline-op
    inputDefinitions:
      parameters:
        pipelinechannel--cd_trigger_id:
          parameterType: STRING
        pipelinechannel--model-evaluator-op-best_model_uri:
          parameterType: STRING
        pipelinechannel--model-evaluator-op-decision:
          parameterType: STRING
        pipelinechannel--project_id:
          parameterType: STRING
  comp-data-ingestion-op:
    executorLabel: exec-data-ingestion-op
    inputDefinitions:
      parameters:
        input_data_gcs_path:
          parameterType: STRING
    outputDefinitions:
      artifacts:
        raw_dataset:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
  comp-model-evaluator-op:
    executorLabel: exec-model-evaluator-op
    inputDefinitions:
      artifacts:
        random_forest_model:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
        svm_model:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
        testing_data:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
        training_data:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
        xgboost_model:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
      parameters:
        model_bucket_name:
          parameterType: STRING
        prod_model_blob:
          parameterType: STRING
    outputDefinitions:
      artifacts:
        metrics:
          artifactType:
            schemaTitle: system.Metrics
            schemaVersion: 0.0.1
      parameters:
        best_model_uri:
          parameterType: STRING
        decision:
          parameterType: STRING
  comp-train-model-op:
    executorLabel: exec-train-model-op
    inputDefinitions:
      artifacts:
        training_data:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
      parameters:
        image_name:
          parameterType: STRING
    outputDefinitions:
      artifacts:
        model_artifact:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
  comp-train-model-op-2:
    executorLabel: exec-train-model-op-2
    inputDefinitions:
      artifacts:
        training_data:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
      parameters:
        image_name:
          parameterType: STRING
    outputDefinitions:
      artifacts:
        model_artifact:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
  comp-train-model-op-3:
    executorLabel: exec-train-model-op-3
    inputDefinitions:
      artifacts:
        training_data:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
      parameters:
        image_name:
          parameterType: STRING
    outputDefinitions:
      artifacts:
        model_artifact:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
  comp-train-test-splitter-op:
    executorLabel: exec-train-test-splitter-op
    inputDefinitions:
      artifacts:
        input_dataset:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
    outputDefinitions:
      artifacts:
        testing_data:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
        training_data:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
  comp-trigger-cd-pipeline-op:
    executorLabel: exec-trigger-cd-pipeline-op
    inputDefinitions:
      parameters:
        new_model_uri:
          parameterType: STRING
        project_id:
          parameterType: STRING
        trigger_id:
          parameterType: STRING
deploymentSpec:
  executors:
    exec-data-ingestion-op:
      container:
        args:
        - --input-data-gcs-path
        - '{{$.inputs.parameters[''input_data_gcs_path'']}}'
        - --output-dataset-path
        - '{{$.outputs.artifacts[''raw_dataset''].path}}'
        command:
        - python3
        - component.py
        image: europe-west4-docker.pkg.dev/data-engineering-vm/yannick-wine-repo/data-ingestion:latest
    exec-model-evaluator-op:
      container:
        args:
        - --training_data_path
        - '{{$.inputs.artifacts[''training_data''].path}}'
        - --testing_data_path
        - '{{$.inputs.artifacts[''testing_data''].path}}'
        - --random_forest_model_path
        - '{{$.inputs.artifacts[''random_forest_model''].path}}'
        - --xgboost_model_path
        - '{{$.inputs.artifacts[''xgboost_model''].path}}'
        - --svm_model_path
        - '{{$.inputs.artifacts[''svm_model''].path}}'
        - --model_bucket_name
        - '{{$.inputs.parameters[''model_bucket_name'']}}'
        - --prod_model_blob
        - '{{$.inputs.parameters[''prod_model_blob'']}}'
        - --decision_path
        - '{{$.outputs.parameters[''decision''].output_file}}'
        - --best_model_uri_path
        - '{{$.outputs.parameters[''best_model_uri''].output_file}}'
        - --metrics_path
        - '{{$.outputs.artifacts[''metrics''].path}}'
        command:
        - python3
        - component.py
        image: europe-west4-docker.pkg.dev/data-engineering-vm/yannick-wine-repo/model-evaluator:latest
    exec-train-model-op:
      container:
        args:
        - --training_data_path
        - '{{$.inputs.artifacts[''training_data''].path}}'
        - --model_artifact_path
        - '{{$.outputs.artifacts[''model_artifact''].path}}'
        command:
        - python3
        - component.py
        image: europe-west4-docker.pkg.dev/data-engineering-vm/yannick-wine-repo/{{$.inputs.parameters['image_name']}}:latest
    exec-train-model-op-2:
      container:
        args:
        - --training_data_path
        - '{{$.inputs.artifacts[''training_data''].path}}'
        - --model_artifact_path
        - '{{$.outputs.artifacts[''model_artifact''].path}}'
        command:
        - python3
        - component.py
        image: europe-west4-docker.pkg.dev/data-engineering-vm/yannick-wine-repo/{{$.inputs.parameters['image_name']}}:latest
    exec-train-model-op-3:
      container:
        args:
        - --training_data_path
        - '{{$.inputs.artifacts[''training_data''].path}}'
        - --model_artifact_path
        - '{{$.outputs.artifacts[''model_artifact''].path}}'
        command:
        - python3
        - component.py
        image: europe-west4-docker.pkg.dev/data-engineering-vm/yannick-wine-repo/{{$.inputs.parameters['image_name']}}:latest
    exec-train-test-splitter-op:
      container:
        args:
        - --input-dataset-path
        - '{{$.inputs.artifacts[''input_dataset''].path}}'
        - --training-data-path
        - '{{$.outputs.artifacts[''training_data''].path}}'
        - --testing-data-path
        - '{{$.outputs.artifacts[''testing_data''].path}}'
        command:
        - python3
        - component.py
        image: europe-west4-docker.pkg.dev/data-engineering-vm/yannick-wine-repo/train-test-splitter:latest
    exec-trigger-cd-pipeline-op:
      container:
        args:
        - --project-id
        - '{{$.inputs.parameters[''project_id'']}}'
        - --trigger-id
        - '{{$.inputs.parameters[''trigger_id'']}}'
        - --new-model-uri
        - '{{$.inputs.parameters[''new_model_uri'']}}'
        command:
        - python3
        - component.py
        image: europe-west4-docker.pkg.dev/data-engineering-vm/yannick-wine-repo/trigger-cd:latest
pipelineInfo:
  name: wine-quality-git-triggered-pipeline
root:
  dag:
    tasks:
      condition-1:
        componentRef:
          name: comp-condition-1
        dependentTasks:
        - model-evaluator-op
        inputs:
          parameters:
            pipelinechannel--cd_trigger_id:
              componentInputParameter: cd_trigger_id
            pipelinechannel--model-evaluator-op-best_model_uri:
              taskOutputParameter:
                outputParameterKey: best_model_uri
                producerTask: model-evaluator-op
            pipelinechannel--model-evaluator-op-decision:
              taskOutputParameter:
                outputParameterKey: decision
                producerTask: model-evaluator-op
            pipelinechannel--project_id:
              componentInputParameter: project_id
        taskInfo:
          name: if-new-model-is-better
        triggerPolicy:
          condition: inputs.parameter_values['pipelinechannel--model-evaluator-op-decision']
            == 'deploy_new'
      data-ingestion-op:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-data-ingestion-op
        inputs:
          parameters:
            input_data_gcs_path:
              componentInputParameter: input_data_gcs_path
        taskInfo:
          name: data-ingestion-op
      model-evaluator-op:
        cachingOptions: {}
        componentRef:
          name: comp-model-evaluator-op
        dependentTasks:
        - train-model-op
        - train-model-op-2
        - train-model-op-3
        - train-test-splitter-op
        inputs:
          artifacts:
            random_forest_model:
              taskOutputArtifact:
                outputArtifactKey: model_artifact
                producerTask: train-model-op
            svm_model:
              taskOutputArtifact:
                outputArtifactKey: model_artifact
                producerTask: train-model-op-3
            testing_data:
              taskOutputArtifact:
                outputArtifactKey: testing_data
                producerTask: train-test-splitter-op
            training_data:
              taskOutputArtifact:
                outputArtifactKey: training_data
                producerTask: train-test-splitter-op
            xgboost_model:
              taskOutputArtifact:
                outputArtifactKey: model_artifact
                producerTask: train-model-op-2
          parameters:
            model_bucket_name:
              componentInputParameter: model_bucket
            prod_model_blob:
              runtimeValue:
                constant: production_model/model.joblib
        taskInfo:
          name: model-evaluator-op
      train-model-op:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-train-model-op
        dependentTasks:
        - train-test-splitter-op
        inputs:
          artifacts:
            training_data:
              taskOutputArtifact:
                outputArtifactKey: training_data
                producerTask: train-test-splitter-op
          parameters:
            image_name:
              runtimeValue:
                constant: model-trainer-rf
        taskInfo:
          name: Train-Random-Forest
      train-model-op-2:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-train-model-op-2
        dependentTasks:
        - train-test-splitter-op
        inputs:
          artifacts:
            training_data:
              taskOutputArtifact:
                outputArtifactKey: training_data
                producerTask: train-test-splitter-op
          parameters:
            image_name:
              runtimeValue:
                constant: model-trainer-xgb
        taskInfo:
          name: Train-XGBoost
      train-model-op-3:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-train-model-op-3
        dependentTasks:
        - train-test-splitter-op
        inputs:
          artifacts:
            training_data:
              taskOutputArtifact:
                outputArtifactKey: training_data
                producerTask: train-test-splitter-op
          parameters:
            image_name:
              runtimeValue:
                constant: model-trainer-svm
        taskInfo:
          name: Train-SVM
      train-test-splitter-op:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-train-test-splitter-op
        dependentTasks:
        - data-ingestion-op
        inputs:
          artifacts:
            input_dataset:
              taskOutputArtifact:
                outputArtifactKey: raw_dataset
                producerTask: data-ingestion-op
        taskInfo:
          name: train-test-splitter-op
  inputDefinitions:
    parameters:
      cd_trigger_id:
        defaultValue: deploy-wine-app-trigger
        isOptional: true
        parameterType: STRING
      input_data_gcs_path:
        defaultValue: gs://yannick-pipeline-root/datasets/wine-latest.csv
        isOptional: true
        parameterType: STRING
      model_bucket:
        defaultValue: yannick-wine-models
        isOptional: true
        parameterType: STRING
      project_id:
        defaultValue: data-engineering-vm
        isOptional: true
        parameterType: STRING
schemaVersion: 2.1.0
sdkVersion: kfp-2.14.6
